#!/usr/bin/env ruby

$:.unshift(File.expand_path("../../lib", __FILE__))

require "trollop"
require "timestamps"
require "zip"

module TRecs
  class Player
    include FileUtils

    def initialize(opts={})
      @file_name = opts[:file_name]

      @dir = Dir.mktmpdir(@filename)
      Zip::File.open(@file_name) do |file|
        file.each do |f|
          f.extract "#{@dir}/#{f.name}"
        end
      end

      @current_time = opts[:time]

      @step = opts[:step]

      @ticks = if !opts[:time]
                 ticks
               else
                 Array(opts[:time].to_i)
               end
    end

    def tick(time=current_time)
      self.current_time = time
      frame = File.read(file_to_read)
      yield frame if block_given?
      frame
    end

    def timestamps
      return [] unless file_name
      @timestamps ||=  Dir.glob("#{@dir}/*").each.map do |line|
        line[/\/(\d++)\Z/, 1].to_i
      end.sort
    end

    def ticks
      if @ticks
        return @ticks
      else
        @ticks = [0]
        curr   = 0
        while(curr < timestamps.last.to_i)
          curr += @step
          @ticks << curr
        end
        @ticks
      end
    end

    private
    attr_reader :file_name
    attr_accessor :current_time

    def file_to_read
      file_array = []
      file_array << @dir
      file_array << "/"
      file_array << time_at(current_time)
      file_to_read = file_array.join
    end

    def time_at(time)
      Timestamps.new(timestamps).time_at(time)
    end
  end
end
#-------------------------

options = Trollop::options do
  opt :file_name,    "File to process",                   short: 'f', type: String
  opt :time,         "Frame at time",                     short: 't', type: String
  opt :current_time, "Returns the current playback time", short: 'c'
  opt :step,         "Time im ms between frames",         short: 's', default: 100

  opt :timestamps,   "Returns the list of existing frame timestamps"

  opt :testing,      "Ticks without waiting. Use this option only for testing purpuses"
end


def clear_screen
  puts "\e[H\e[2J"
end


def play_frame(player, time)
  clear_screen
  puts player.tick(time)
end


file_name = options[:file_name]
if file_name
  if File.exist?(file_name)
    player = TRecs::Player.new(options)
    if options[:timestamps]
      p player.timestamps
    else
      # TODO: Fix this to use the current time
      step = (options[:step]/1000.0)*0.8
      player.ticks.each do |time|
        play_frame(player, time)
        sleep(step) unless options[:testing]
      end
    end
  else
    puts "File #{file_name} does not exist."
  end
end
