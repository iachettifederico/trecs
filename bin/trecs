#!/usr/bin/env ruby

$:.unshift(File.expand_path("../../lib", __FILE__))

require "trollop"

require "timestamps"
require "zip_file_player"

options = Trollop::options do
  opt :file_name,    "File to process",                   short: 'f', type: String
  opt :time,         "Frame at time",                     short: 't', type: String
  opt :current_time, "Returns the current playback time", short: 'c'
  opt :step,         "Time im ms between frames",         short: 's', default: 100

  opt :timestamps,   "Returns the list of existing frame timestamps"

  opt :testing,      "Ticks without waiting. Use this option only for testing purpuses"
end

def clear_screen
  puts "\e[H\e[2J"
end

def play_frame(player, time)
  clear_screen
  puts player.tick(time)
end

file_name = options[:file_name]
if file_name
  if File.exist?(file_name)
    player = TRecs::ZipFilePlayer.new(options)
    if options[:timestamps]
      p player.timestamps
    else
      # TODO: Fix this to use the current time
      step = (options[:step]/1000.0)*0.8
      player.ticks.each do |time|
        play_frame(player, time)
        sleep(step) unless options[:testing]
      end
    end
  else
    puts "File #{file_name} does not exist."
  end
end
